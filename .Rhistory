?save
compres
compress
save
inherits("place", "connection")
?writeBin
#####################################
# Do registrations and get the caths
#####################################
rm(list=ls())
library(extrantsr)
library(fslr)
id = "6001-161"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
setwd("~/Desktop/Caths/6003-157/")
#####################################
# Do registrations and get the caths
#####################################
rm(list=ls())
library(extrantsr)
library(fslr)
id = "6001-161"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
# post_time = "20131231_215443"
# mid_time = "20131230_152758"
# pre_time = "20131230_084902"
dir()
#####################################
# Do registrations and get the caths
#####################################
rm(list=ls())
library(extrantsr)
library(fslr)
id = "6001-161"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
# post_time = "20131231_215443"
# mid_time = "20131230_152758"
# pre_time = "20131230_084902"
post_time = "20140118_015400"
mid_time = "20140117_183400"
pre_time = "20140116_015400"
df = data.frame(
times = c(post_time,
mid_time,
pre_time),
types = c("post", "mid", "pre"),
stringsAsFactors = FALSE)
df$img = img_fname(df$times)
df$roi = roi_fname(df$times)
df$mask = mask_fname(df$times)
df$reg = prev_fname(df$times)
df$roi_out = roi_out(df$times)
rownames(df) = df$types
df
regger = function(ttype = "post",
before = "mid"){
oo = c(df[ttype, "roi_out"],
df[ttype, "reg"]
)
if (!all(file.exists(oo))){
out = registration(
filename = df[ttype, "img"],
outfile = df[ttype, "reg"],
template.file = df[before, "img"],
other.files = df[ttype, "roi"],
other.outfiles = df[ttype, "roi_out"],
typeofTransform = "Rigid")
}
reg_mid = regger("post", "mid")
reg_out = regger("mid", "pre")
df$img
#####################################
# Do registrations and get the caths
#####################################
rm(list=ls())
library(extrantsr)
library(fslr)
# id = "6001-161"
id = "6003-157"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
# post_time = "20131231_215443"
# mid_time = "20131230_152758"
# pre_time = "20131230_084902"
post_time = "20140118_015400"
mid_time = "20140117_183400"
pre_time = "20140116_015400"
df = data.frame(
times = c(post_time,
mid_time,
pre_time),
types = c("post", "mid", "pre"),
stringsAsFactors = FALSE)
df$img = img_fname(df$times)
df$roi = roi_fname(df$times)
df$mask = mask_fname(df$times)
df$reg = prev_fname(df$times)
df$roi_out = roi_out(df$times)
rownames(df) = df$types
regger = function(ttype = "post",
before = "mid"){
oo = c(df[ttype, "roi_out"],
df[ttype, "reg"]
)
if (!all(file.exists(oo))){
out = registration(
filename = df[ttype, "img"],
outfile = df[ttype, "reg"],
template.file = df[before, "img"],
other.files = df[ttype, "roi"],
other.outfiles = df[ttype, "roi_out"],
typeofTransform = "Rigid")
}
reg_mid = regger("post", "mid")
reg_out = regger("mid", "pre")
#####################################
# Do registrations and get the caths
#####################################
rm(list=ls())
library(fslr)
library(extrantsr)
library(dplyr)
library(msseg)
# id = "6001-161"
id = "6003-157"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
# post_time = "20131231_215443"
# mid_time = "20131230_152758"
# pre_time = "20131230_084902"
post_time = "20140118_015400"
mid_time = "20140117_183400"
pre_time = "20140116_015400"
df = data.frame(
times = c(post_time,
mid_time,
pre_time),
types = c("post", "mid", "pre"),
stringsAsFactors = FALSE)
df$img = img_fname(df$times)
df$roi = roi_fname(df$times)
df$mask = mask_fname(df$times)
df$reg = prev_fname(df$times)
df$roi_out = roi_out(df$times)
rownames(df) = df$types
df$voxres = df$roi %>% sapply(voxres)
df$roi_vol = df$roi %>% sapply(fslvol)
get_cath = function(
after = "mid",
before = "pre",
ero_max = 2){
a_img = df[after, "reg"] %>%
readnii
wa_img = window_img(a_img)
a_roi = df[after, "roi_out"] %>%
readnii
a_roi_mask = a_roi > 0.5
b_img = df[before, "img"] %>%
readnii
wb_img = window_img(b_img)
b_mask = df[before, "mask"] %>%
readnii
b_roi = df[before, "roi"] %>%
readnii
tab = extrantsr:::my.tab(
a_roi_mask,
b_roi)
dice = dicer(tab, verbose = FALSE)
vdim = voxdim(b_mask)
vres = voxres(b_mask, units = "cm")
a_roi_vol = sum(a_roi_mask)*vres
b_roi_vol = sum(b_roi)*vres
###################
# eroding mask
###################
n = ero_max / vdim
zero = floor(n) == 0
n = 2 * floor((n+1)/2) -1
n[zero] = 0
n[n < 0] = 0
kern = paste0("-kernel boxv ",
paste(n, collapse = "x"))
be_mask = b_mask %>% fslerode(
kopts = kern)
diff_img = a_img - b_img
ocath = diff_img > 10 &
be_mask > 0 &
a_img > 100
cath = ocath %>%
oMath("GetLargestComponent")
cath_vol = fslvol(cath)
if (cath_vol < 2) {
message("no catheter")
cath = niftiarr(cath, 0)
cath_vol = 0
}
dd = dropEmptyImageDimensions(b_mask,
other.imgs = list(wa_img = wa_img,
wb_img = wb_img,
cath = cath,
a_roi = a_roi_mask,
b_roi = b_roi))
dd = dd$other.imgs
cath = dd$cath
a_roi = dd$a_roi
b_roi = dd$b_roi
wa_img = dd$wa_img
wb_img = dd$wb_img
L = list(
cath= cath,
cath_vol = cath_vol,
before_roi_vol = b_roi_vol,
after_roi_vol = a_roi_vol,
tab = tab,
dice = dice,
a_img = wa_img,
b_img = wb_img,
a_roi = a_roi,
b_roi = b_roi
)
}
pdfer = function(surg, pdfname) {
ttext = paste0("Before Vol: ",
round(surg$before_roi_vol, 1),
"\n After Vol:",
round(surg$after_roi_vol, 1),
"\n Dice: ",
round(surg$dice, 3)
)
tstub = tempfile()
tfile = paste0(tstub, "%04d.png")
png(tfile, res = 300,
height = 7,
width = 7,
units = "in",
type = "cairo")
double_ortho(surg$b_img,
surg$a_img,
text = ttext)
ortho_diff(
surg$b_img,
roi = surg$b_roi,
pred = surg$a_roi,
xyz = xyz(surg$b_roi)
)
cath = surg$cath
xyz = NULL
if (surg$cath_vol > 0){
cath_text = paste0("Cath Vol: ",
round(surg$cath_vol, 1)
)
xyz = xyz(surg$cath)
} else {
cath = NULL
}
ortho2(surg$b_img,
xyz = xyz,
text = "Before")
ortho2(surg$a_img,
xyz = xyz,
text = "After")
ortho2(surg$b_img,
cath,
xyz = xyz,
text = "Cath")
dev.off()
png_converter(
paste0(tstub, "*.png"),
pdfname)
}
post_surg = get_cath("post", "mid")
writenii(post_surg$cath,
paste0(nii.stub(df["post", "reg"]),
"_Cath.nii.gz")
)
pdfer(surg = post_surg, "mid_post.pdf")
pre_surg = get_cath("mid", "pre")
pdfer(surg = pre_surg, "pre_mid.pdf")
surg = post_surg
cath = surg$cath
csums = apply(cath, 3, sum)
csums
which.max(csums)
csums = apply(cath, 3, sum)
z = which.max(csums)
ind = which(cath > 0, arr.ind = TRUE)
ind = ind[ind[,3] == z,]
ind
cxyz = floor(colMeans(ind))
cxyz
source('~/Desktop/Caths/Catheters.R')
#####################################
# Do registrations and get the caths
#####################################
rm(list = ls())
library(fslr)
library(extrantsr)
library(dplyr)
library(msseg)
id = "6001-161"
# id = "6003-157"
img_fname = function(stub){
paste0(id, "_",
stub, "_SCAN.nii.gz")
}
roi_fname = function(stub){
paste0(id, "_",
stub, "_ROI.nii.gz")
}
mask_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_Mask.nii.gz")
}
roi_out = function(stub){
paste0(nii.stub(roi_fname(stub)),
"_to_Previous.nii.gz")
}
prev_fname = function(stub){
paste0(nii.stub(img_fname(stub)),
"_to_Previous.nii.gz")
}
#
if (id == "6001-161"){
post_time = "20131231_215443"
mid_time = "20131230_152758"
pre_time = "20131230_084902"
}
if (id == "6003-157"){
post_time = "20140118_015400"
mid_time = "20140117_183400"
pre_time = "20140116_015400"
}
df = data.frame(
times = c(post_time,
mid_time,
pre_time),
types = c("post", "mid", "pre"),
stringsAsFactors = FALSE)
df$img = img_fname(df$times)
df$roi = roi_fname(df$times)
df$mask = mask_fname(df$times)
df$reg = prev_fname(df$times)
df$roi_out = roi_out(df$times)
rownames(df) = df$types
df$voxres = df$roi %>% sapply(voxres)
df$roi_vol = df$roi %>% sapply(fslvol)
setwd("../6001-161/")
source('~/Desktop/Caths/Catheters.R')
knitr::opts_chunk$set(echo = FALSE)
img = mni_img()
mni_i
mni_img()
?mni_img()
?mni_img
library(fslr)
img = mni_img()
library(fslr)
img = mni_img()
img
ortho2(img)
img = mni_img(brain = TRUE)
library(fslr)
img = mni_img(brain = TRUE)
img = dropEmptyImageDimensions(img)
ortho2(img)
library(manipulate)
?manipulate
citation("manipulate")
knitr::opts_chunk$set(echo = FALSE,
warning = FALSE,
message = FALSE)
library(papayar)
papaya(imgs, outdir = ".")
papaya(img, outdir = ".")
embed_papaya()
embed_papaya
knitr::opts_chunk$set(echo = FALSE,
warning = FALSE,
message = FALSE)
library(fslr)
img = mni_img(brain = TRUE)
img = dropEmptyImageDimensions(img)
img = mni_img(brain = TRUE)
img = dropEmptyImageDimensions(img)
ortho2(img)
writenii(img, "reduced_mni.nii.gz")
library(papayar)
embed_papaya("reduced_mni.nii.gz", outdir = ".")
x = embed_papaya("reduced_mni.nii.gz", outdir = ".")
x
embed_papaya
index.file <- system.file("embed.html", package="papayar")
index.file
readLines(index.file)
cat(readLines(index.file))
library(papayar)
hist(c(img))
knitr::opts_chunk$set(echo = FALSE,
warning = FALSE,
message = FALSE)
img = dropEmptyImageDimensions(img)
library(fslr)
img = mni_img(brain = TRUE)
img = dropEmptyImageDimensions(img)
hist(c(img))
thresh = img > 6500
ortho2(img, thresh)
thresh = img > 7000
writenii(thresh, "threshold.nii.gz")
ortho2(img, thresh)
hist(c(img))
thresh = img > 7500
writenii(thresh, "threshold.nii.gz")
ortho2(img, thresh)
system("open .")
