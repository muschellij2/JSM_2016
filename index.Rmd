---
title: "Papayar: An interactive neuroimage plotter with R"
subtitle: "John Muschelli, \\@StrictlyStat"
author: "presentation: http://johnmuschelli.com/JSM_2016"
date: "code: http://github.com/muschellij2/JSM_2016"
bibliography: JSM_2016.bib
output:
  ioslides_presentation:
    self_contained: false
    widescreen: true
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

## Problem: Images are 3D: Brain

```{r plot}
library(fslr)
library(extrantsr)
library(WhiteStripe)
x = download_img_data()
rm(list = 'x')
img_fname = "reduced_t1.nii.gz"
mask_fname = "reduced_t1_mask.nii.gz"
if (!all(file.exists(c(img_fname,
                       mask_fname)))) {
  t1_fname = system.file("T1Strip.nii.gz", 
                         package = "WhiteStripe")
  img = readnii(t1_fname)
  mask = img > 0
  dd = dropEmptyImageDimensions(mask, 
                                other.imgs = img)
  img = dd$other.imgs
  writenii(img, img_fname)
  mask = dd$outimg
  writenii(mask, mask_fname)
} else {
  img = readnii(img_fname)
  mask = readnii(mask_fname)
}
```

```{r wm_seg}
seg_fname = "t1_seg.nii.gz"
if (!file.exists(seg_fname)) {
  res = otropos(a = img, x = mask)
  seg = res$segmentation 
  writenii(seg, seg_fname)
} else {
  seg = readnii(seg_fname)
}
seg_img = seg == 2
writenii(seg_img, "overlay.nii.gz")
i2 = fslswapdim(img, a = "-x")
t2 = fslswapdim(seg_img, a = "-x")
ortho2(i2, add.orient = FALSE)
```

## Explore results: e.g. Gray Matter Segmentation

```{r thresh}
ortho2(i2, t2, add.orient = FALSE, col.y = "green")
```

## Let's make it interactive!

- Are static graphics (e.g. PDFs/GIFs) good enough?

<img src="images/philosoraptor.jpeg" style="width: 40%; display: block; margin: auto;">

<p style="font-size: 10pt">image from [http://cheezburger.com](http://cheezburger.com)</p>

## Let's make it interactive!

- Are static graphics (e.g. PDFs/GIFs) good enough?

- What step in the analysis does it come in? For me:
    - exploratory - looking at where image outcomes occur
    - confirmatory - see how model predicts image outcome



## But other (standalone) programs can do this!

<img src="images/stacked.gif" style="width: 60%; display: block; margin: auto;">

## My Principle of interactivity

- Should be scriptable to get the interactive graphic
    - still hard to script/reproduce the **interaction**
    
- Should be within the analysis workflow
    - Others are just standalone viewers
    - Relies on fewer systems/dependencies

- I tried R

## First Attempt: Use manipulate

The `manipulate` package [@manipulate] from RStudio can add interactivity, BUT:

- Images rendering was slow (due to the R plotting function)
- Only works with RStudio
- Can't be embedded in document

## Second Attempt: Set of PDFs or one GIFs!

The `animation` package [@animation1, @animation2] can easily make GIFs with the images:

<img src="images/slice_movie.gif" style="width: 40%; display: block; margin: auto;">


## Second Attempt: Set of PDFs or one GIFs!

<img src="images/slice_movie.gif" style="width: 10%; display: block; margin: auto;">


Pros:    

- Just plotting with regular functions
    - Can be embedded into an html easily

Cons: 

- Not really "interactive"
    - less choice on user's end
    - not easy to move back/forward or different view

```{r gif, results='hide'}
library(msseg)
library(scales)
outname = "images/slice_movie.gif"
# if (!file.exists(outname)) {
    nz = nsli(i2)
    # n_slices = nz
    n_slices = 20
    probs = seq(1/(n_slices * 2), 
                1 - 1/(n_slices * 2), 
                length.out = n_slices)
    slices = round(quantile(seq(nz), probs = probs))
    slices = unique(slices)
    
    t3 = t2
    t3[t2 == 0] = NA
    t3 = cal_img(t3)
    tstub = tempfile()
    tfile = paste0(tstub, "_%04d.png")
    png(tfile, 
        res = 300, 
        height = 7, 
        width = 7,
        units = "in",
        type = "cairo")
    for (slice in slices) {
      oro.nifti::overlay(x = i2, y = t3, 
              z = slice,
              col.y = alpha("green", 0.5),
              plot.type = "single")
    }
    dev.off()
    png_converter(
      paste0(tstub, "*.png"),
      extra.opts = "-density 300",
      interval = 0.5,
      outname)
# }
```

## Solution: Port papaya: JavaScript library

<div style="width:80%; height:55%; display: block; margin: auto;">
```{r div, results='asis'}
library(papayar)
x = papaya_div()
cat(x)
```
</div>

## Is it an htmlwidget!? 

<p style="font-size: 140pt; vertical-align: middle; text-align: left;">No</p>


## Is it an htmlwidget!?

<p style="font-size: 140pt; vertical-align: middle; text-align: left;">Not yet.</p>


## Lessons Learned

- Borrow (heavily) other people's stuff
- Porting to R can help the community
    - not always so straightforward
    - Functionality at the whim of the maintainer
    - not std R
- htmlwidgets is great
    - not always super easy for a user to cram into
    


## Bibliography
